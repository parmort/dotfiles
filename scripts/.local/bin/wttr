#!/bin/bash

weather="${XDG_DATA_HOME:-$HOME/.local/share}/wttr"

update_weather() {
  curl -sf "wttr.in" > "$weather" || exit 1
}

case $1 in
  --pager)
    setsid -f "$TERMINAL" --class=Alacritty,Wttr -e less -Srf "$weather"
    exit 0
    ;;
  --update)
    update_weather
    notify-send -i weather-few-clouds "wttr.in" "Weather Updated"
    ;;
esac

# Get the new weather report each day
[ "$(stat -c %y "$weather" 2>/dev/null | cut -d' ' -f1)" = "$(date '+%Y-%m-%d')" ] ||
  update_weather

sed '13q;d' $weather | grep -o "m\\([-+]\\)*[0-9]\\+" | sort -n -t 'm' -k 2n |
  sed -e 1b -e '$!d' | tr '\n|m' ' ' | awk '{print $1 "°" "–" $2 "°"}'
